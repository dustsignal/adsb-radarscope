<!DOCTYPE html>
<!--
  ADSB Radarscope
  Author: dustsignal
  Version: 0.2.0.aplha.a
  GitHub: https://github.com/dustsignal/adsb-scope

  This program is free software: you can redistribute it and/or modify
  it under the terms of the GNU General Public License as published by
  the Free Software Foundation, either version 3 of the License, or
  (at your option) any later version.

  This program is distributed in the hope that it will be useful,
  but WITHOUT ANY WARRANTY; without even the implied warranty of
  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
  GNU General Public License for more details.

  You should have received a copy of the GNU General Public License
  along with this program.  If not, see <https://www.gnu.org/licenses/>.
-->
<html lang="en" data-ui-theme="default-dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ADSB Radarscope</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        // Theme configuration
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        // Scope Themes
                        'classic-green':  { background: '#001200', grid: '#003300', sweep: '#00FF00', aircraft: '#00FF00', selected: '#CCFFCC', emergency: '#FF6666', ground: '#00B300', text: '#C8FFC8' },
                        'arctic-blue':    { background: '#050A14', grid: '#14294F', sweep: '#63C7FF', aircraft: '#00FFFF', selected: '#FFFF00', emergency: '#FF3333', ground: '#63C7FF', text: '#DCF0FF' },
                        'desert-amber':   { background: '#140A00', grid: '#4F3314', sweep: '#FFB300', aircraft: '#FFC763', selected: '#FFFFDB', emergency: '#FF3D3D', ground: '#FFB300', text: '#FFDCB4' },
                        'night-vision':   { background: '#000000', grid: '#003D00', sweep: '#00FF00', aircraft: '#00FF00', selected: '#CCFFCC', emergency: '#FF0000', ground: '#00B300', text: '#00FF00' },
                        'stealth-gray':   { background: '#14141A', grid: '#3D3D45', sweep: '#B3B3C7', aircraft: '#DBDBF0', selected: '#FFFF66', emergency: '#FF4F4F', ground: '#B3B3C7', text: '#DCDCF0' },
                        'crimson-alert':  { background: '#1A0000', grid: '#4F0000', sweep: '#FF3333', aircraft: '#FF9999', selected: '#FFFFCC', emergency: '#FFFF00', ground: '#FF3333', text: '#FFC8C8' },
                        'cyberpunk':      { background: '#0A0014', grid: '#4F144F', sweep: '#FF00FF', aircraft: '#00FFFF', selected: '#FFFF00', emergency: '#FF1494', ground: '#FF00FF', text: '#DCDCFE' },
                        'solar-flare':    { background: '#1a0d00', grid: '#4d2a00', sweep: '#ffdd00', aircraft: '#ffaa00', selected: '#ffffff', emergency: '#ff4400', ground: '#ffdd00', text: '#ffecb3' },
                        'deep-ocean':     { background: '#00051a', grid: '#001a4d', sweep: '#00aaff', aircraft: '#66ccff', selected: '#f0f8ff', emergency: '#ff3333', ground: '#00aaff', text: '#cceeff' },
                        'forest-camo':    { background: '#0a1a0a', grid: '#1f4d1f', sweep: '#66ff66', aircraft: '#aaffaa', selected: '#ffffcc', emergency: '#ff6600', ground: '#66ff66', text: '#d9ffd9' },
                        'volcanic-ash':   { background: '#101010', grid: '#333333', sweep: '#ff4d4d', aircraft: '#ff8080', selected: '#ffff00', emergency: '#ff0000', ground: '#ff4d4d', text: '#cccccc' },
                        'nebula-purple':  { background: '#10001a', grid: '#3d004d', sweep: '#ff00ff', aircraft: '#ff99ff', selected: '#ccffff', emergency: '#ff3333', ground: '#ff00ff', text: '#f2ccff' },
                        'ghost-white':    { background: '#1a1a1a', grid: '#4d4d4d', sweep: '#ffffff', aircraft: '#cccccc', selected: '#00ff00', emergency: '#ff0000', ground: '#ffffff', text: '#e6e6e6' },
                        'golden-age':     { background: '#1a1400', grid: '#4d4200', sweep: '#ffd700', aircraft: '#ffec80', selected: '#ffffff', emergency: '#ff4500', ground: '#ffd700', text: '#fff5cc' },
                        'retro-vga':      { background: '#0000a0', grid: '#0000c0', sweep: '#ffffff', aircraft: '#00ff00', selected: '#ffff00', emergency: '#ff0000', ground: '#00ff00', text: '#c0c0c0' },
                        'toxic-sludge':   { background: '#1a1a00', grid: '#4d4d00', sweep: '#adff2f', aircraft: '#d2ff80', selected: '#ffffff', emergency: '#ff0000', ground: '#adff2f', text: '#eaffcc' },
                        'strawberry-cream':{ background: '#2a0d0d', grid: '#6a2a2a', sweep: '#ffb6c1', aircraft: '#ffdde1', selected: '#ffffff', emergency: '#ff0000', ground: '#ffb6c1', text: '#ffe6e8' },
                        'blueprint':      { background: '#00002a', grid: '#00006a', sweep: '#ffffff', aircraft: '#87cefa', selected: '#ffff00', emergency: '#ff4500', ground: '#ffffff', text: '#d0e0ff' },
                        'hacker-matrix':  { background: '#000000', grid: '#002200', sweep: '#00ff00', aircraft: '#66ff66', selected: '#ffffff', emergency: '#ff0000', ground: '#00cc00', text: '#00ff00' },
                        'autumn-leaves':  { background: '#2a0a00', grid: '#6a2a00', sweep: '#ff8c00', aircraft: '#ffd480', selected: '#ffff00', emergency: '#dc143c', ground: '#ff8c00', text: '#ffeacc' },
                        'coral-reef':     { background: '#001a1a', grid: '#004d4d', sweep: '#7fffd4', aircraft: '#ff7f50', selected: '#f0ffff', emergency: '#ff1493', ground: '#7fffd4', text: '#ccfff2' },
                        'lunar-rock':     { background: '#222222', grid: '#444444', sweep: '#c0c0c0', aircraft: '#dddddd', selected: '#00ff00', emergency: '#ff3333', ground: '#c0c0c0', text: '#e0e0e0' },
                        'sandstone':      { background: '#2a1d0d', grid: '#6a4a2a', sweep: '#f4a460', aircraft: '#ffdead', selected: '#ffffff', emergency: '#ff4500', ground: '#f4a460', text: '#ffefd9' },
                        'royal-velvet':   { background: '#1a001a', grid: '#4d004d', sweep: '#8a2be2', aircraft: '#da70d6', selected: '#ffd700', emergency: '#ff0000', ground: '#8a2be2', text: '#efccff' },
                        'mint-chocolate': { background: '#100a0a', grid: '#3d2a2a', sweep: '#98ff98', aircraft: '#d9ffd9', selected: '#ffffff', emergency: '#ff4500', ground: '#98ff98', text: '#e6ffe6' },
                        'infrared-heat':  { background: '#000000', grid: '#220000', sweep: '#ff0000', aircraft: '#ffff00', selected: '#ffffff', emergency: '#ff0000', ground: '#ff9900', text: '#ffaaaa' },
                        'plasma-burn':    { background: '#11001a', grid: '#3d004d', sweep: '#ff00ff', aircraft: '#ff66ff', selected: '#00ffff', emergency: '#ffff00', ground: '#ff00ff', text: '#f2ccff' },
                        'cold-steel':     { background: '#0d131a', grid: '#2a3a4d', sweep: '#add8e6', aircraft: '#e0ffff', selected: '#ffffff', emergency: '#ff3333', ground: '#add8e6', text: '#d9ecf2' },
                        'digital-rain':   { background: '#000510', grid: '#001530', sweep: '#00ffff', aircraft: '#00aaff', selected: '#00ff00', emergency: '#ff0000', ground: '#00dddd', text: '#aaddff' },
                        'copper-rust':    { background: '#2a0a00', grid: '#6a2a00', sweep: '#b87333', aircraft: '#daa520', selected: '#00ffff', emergency: '#ff0000', ground: '#008080', text: '#ffeacc' },
                        'aurora-borealis':{ background: '#00001a', grid: '#002030', sweep: '#00ff7f', aircraft: '#ff69b4', selected: '#ffffff', emergency: '#ff0000', ground: '#32cd32', text: '#ccffee' },
                        'vintage-sepia':  { background: '#2a1d0d', grid: '#504030', sweep: '#d2b48c', aircraft: '#f5deb3', selected: '#ffffff', emergency: '#a52a2a', ground: '#d2b48c', text: '#fff0d9' },
                        'acid-wash':      { background: '#1a001a', grid: '#4d004d', sweep: '#ff00ff', aircraft: '#00ffff', selected: '#ffff00', emergency: '#ff1493', ground: '#ff00ff', text: '#efccff' },
                        'moonlit':        { background: '#0d0d1a', grid: '#2a2a4d', sweep: '#c0c0c0', aircraft: '#f0f8ff', selected: '#00ff00', emergency: '#ff4500', ground: '#c0c0c0', text: '#e6e6ff' },
                        'lava-flow':      { background: '#1a0000', grid: '#4d0000', sweep: '#ff4500', aircraft: '#ff8c00', selected: '#ffff00', emergency: '#ff0000', ground: '#ff4500', text: '#ffcccc' },
                        'emerald-city':   { background: '#001a0a', grid: '#004d1f', sweep: '#00ff00', aircraft: '#ffd700', selected: '#ffffff', emergency: '#ff0000', ground: '#50c878', text: '#ccffdd' },
                        'grape-soda':     { background: '#1a0d1a', grid: '#4d2a4d', sweep: '#da70d6', aircraft: '#dda0dd', selected: '#ffffff', emergency: '#ff00ff', ground: '#da70d6', text: '#f2e6f2' },
                        'starfield':      { background: '#03051e', grid: '#1c2152', sweep: '#dadaff', aircraft: '#ffffaa', selected: '#aaffff', emergency: '#ff5555', ground: '#dadaff', text: '#dadaff' },
                        'jungle':         { background: '#081405', grid: '#2a4f14', sweep: '#a3ff00', aircraft: '#d4ff63', selected: '#ffffff', emergency: '#ff3d3d', ground: '#a3ff00', text: '#c8ffb4' },
                        'biohazard':      { background: '#141100', grid: '#4f4414', sweep: '#fff700', aircraft: '#b8ff63', selected: '#ffffff', emergency: '#ff0000', ground: '#fff700', text: '#ffffb4' },
                        'daylight':       { background: '#dce8f2', grid: '#aabccc', sweep: '#0077ff', aircraft: '#ff3333', selected: '#0000ff', emergency: '#ff0000', ground: '#0099ff', text: '#224466' },
                        'cad':            { background: '#ffffff', grid: '#cccccc', sweep: '#888888', aircraft: '#0000ff', selected: '#ff00ff', emergency: '#ff0000', ground: '#0000ff', text: '#000000' },
                        'blueprint-light':{ background: '#e0e8f6', grid: '#a8bedc', sweep: '#ffffff', aircraft: '#0033cc', selected: '#ff3300', emergency: '#cc0000', ground: '#0033cc', text: '#002266' },
                        'paper-map':      { background: '#f5f3e8', grid: '#dcd9c8', sweep: '#b1a18c', aircraft: '#d9534f', selected: '#0275d8', emergency: '#ff0000', ground: '#b1a18c', text: '#6a5f4b' },
                        'arctic-light':   { background: '#f0f8ff', grid: '#c0d8ef', sweep: '#63c7ff', aircraft: '#0088cc', selected: '#0000ff', emergency: '#ff3333', ground: '#63c7ff', text: '#052a4f' },
                        'sandstorm':      { background: '#fdf6e3', grid: '#eee8d5', sweep: '#dc322f', aircraft: '#268bd2', selected: '#d33682', emergency: '#ff0000', ground: '#dc322f', text: '#657b83' },
                        'medical':        { background: '#ffffff', grid: '#d0d0d0', sweep: '#00a0a0', aircraft: '#d90000', selected: '#0000d9', emergency: '#ff0000', ground: '#00a0a0', text: '#444444' },
                        'clean-room':     { background: '#f8f8f8', grid: '#d8d8d8', sweep: '#a0a0a0', aircraft: '#000000', selected: '#0000ff', emergency: '#ff0000', ground: '#888888', text: '#333333' },
                        'graph-paper':    { background: '#ffffff', grid: '#add8e6', sweep: '#4682b4', aircraft: '#ff4500', selected: '#32cd32', emergency: '#ff0000', ground: '#4682b4', text: '#00008b' },
                        'hi-vis':         { background: '#ffffff', grid: '#c0c0c0', sweep: '#ffaa00', aircraft: '#000000', selected: '#ff00ff', emergency: '#ff0000', ground: '#ffaa00', text: '#000000' },
                    }
                }
            }
        }
    </script>
    <style>
        /* Base styles */
        html, body { margin: 0; overflow: hidden; height: 100vh; }
        .table-cell { padding: 0.25rem 0.5rem; white-space: nowrap; }
        .dropdown-menu { transition: opacity 0.2s ease, transform 0.2s ease; }
        
        /* Resizer styles */
        .resizer {
            width: 5px;
            cursor: col-resize;
            background-color: var(--color-resizer-bg);
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .resizer:hover { background-color: #3b82f6; }
        .resizer-indicator {
            width: 1px;
            height: 16px;
            background-color: var(--color-resizer-indicator);
            border-left: 1px solid var(--color-resizer-border);
            border-right: 1px solid var(--color-resizer-border);
        }

        /* Animation for emergency alerts */
        @keyframes slideInFadeOut {
            0% { opacity: 0; transform: translateX(100%); }
            15% { opacity: 1; transform: translateX(0); }
            85% { opacity: 1; transform: translateX(0); }
            100% { opacity: 0; transform: translateX(100%); }
        }
        .alert-animate { animation: slideInFadeOut 6s forwards; }
        
        /* UI Theme CSS Variables */
        :root {
            /* Default light theme */
            --color-bg-primary: #ffffff;
            --color-bg-panel: #f3f4f6;
            --color-text-primary: #1f2937;
            --color-text-muted: #6b7280;
            --color-border: #e5e7eb;
            --color-button-bg: #e5e7eb;
            --color-button-hover: #d1d5db;
            --color-kbd-bg: #e5e7eb;
            --color-kbd-text: #1f2937;
            --color-kbd-border: #d1d5db;
            --color-resizer-bg: #e5e7eb;
            --color-resizer-indicator: #9ca3af;
            --color-resizer-border: #ffffff;
            --color-table-header: #e5e7eb;
            --color-table-odd-row: #f9fafb;
            --color-selected-row: #93c5fd;
        }

        /* Light theme base */
        .theme-light {
            --color-bg-primary: #ffffff;
            --color-bg-panel: #f3f4f6;
            --color-text-primary: #1f2937;
            --color-text-muted: #6b7280;
            --color-border: #e5e7eb;
            --color-button-bg: #e5e7eb;
            --color-button-hover: #d1d5db;
            --color-kbd-bg: #e5e7eb;
            --color-kbd-text: #1f2937;
            --color-kbd-border: #d1d5db;
            --color-resizer-bg: #e5e7eb;
            --color-resizer-indicator: #9ca3af;
            --color-resizer-border: #ffffff;
            --color-table-header: #e5e7eb;
            --color-table-odd-row: #f9fafb;
            --color-selected-row: #93c5fd;
        }

        /* Dark theme base */
        .theme-dark {
            --color-bg-primary: #1f2937;
            --color-bg-panel: #111827;
            --color-text-primary: #f9fafb;
            --color-text-muted: #9ca3af;
            --color-border: #374151;
            --color-button-bg: #374151;
            --color-button-hover: #4b5563;
            --color-kbd-bg: #111827;
            --color-kbd-text: #d1d5db;
            --color-kbd-border: #374151;
            --color-resizer-bg: #374151;
            --color-resizer-indicator: #6b7280;
            --color-resizer-border: #4b5563;
            --color-table-header: #374151;
            --color-table-odd-row: #1f293780;
            --color-selected-row: #1e40af;
        }

        /* Specific theme overrides */
        :root[data-ui-theme="default-light"] { @extend .theme-light; }
        :root[data-ui-theme="stone"] {
            @extend .theme-light;
            --color-bg-primary: #fafaf9;
            --color-bg-panel: #f5f5f4;
            --color-text-primary: #292524;
            --color-text-muted: #78716c;
            --color-border: #e7e5e4;
            --color-button-bg: #e7e5e4;
            --color-button-hover: #d6d3d1;
            --color-selected-row: #bbf7d0;
        }
        :root[data-ui-theme="mint"] {
            @extend .theme-light;
            --color-bg-primary: #f0fdf4;
            --color-bg-panel: #dcfce7;
            --color-text-primary: #166534;
            --color-text-muted: #15803d;
            --color-border: #bbf7d0;
            --color-button-bg: #bbf7d0;
            --color-button-hover: #86efac;
            --color-selected-row: #fda4af;
        }
        :root[data-ui-theme="sky"] {
            @extend .theme-light;
            --color-bg-primary: #f0f9ff;
            --color-bg-panel: #e0f2fe;
            --color-text-primary: #075985;
            --color-text-muted: #0369a1;
            --color-border: #bae6fd;
            --color-button-bg: #bae6fd;
            --color-button-hover: #7dd3fc;
            --color-selected-row: #fcd34d;
        }
        :root[data-ui-theme="lavender"] {
            @extend .theme-light;
            --color-bg-primary: #faf5ff;
            --color-bg-panel: #f3e8ff;
            --color-text-primary: #581c87;
            --color-text-muted: #7e22ce;
            --color-border: #e9d5ff;
            --color-button-bg: #e9d5ff;
            --color-button-hover: #d8b4fe;
            --color-selected-row: #a5b4fc;
        }
        :root[data-ui-theme="paper"] {
            @extend .theme-light;
            --color-bg-primary: #fefcf7;
            --color-bg-panel: #fdf8ed;
            --color-text-primary: #484234;
            --color-text-muted: #7e735f;
            --color-border: #e9e2d4;
            --color-button-bg: #e9e2d4;
            --color-button-hover: #d8d0bf;
            --color-selected-row: #818cf8;
        }
        :root[data-ui-theme="azure"] {
            @extend .theme-light;
            --color-bg-primary: #f5faff;
            --color-bg-panel: #eef5ff;
            --color-text-primary: #2c5282;
            --color-text-muted: #3182ce;
            --color-border: #bee3f8;
            --color-button-bg: #bee3f8;
            --color-button-hover: #90cdf4;
            --color-selected-row: #f6ad55;
        }
        :root[data-ui-theme="default-dark"] { @extend .theme-dark; }
        :root[data-ui-theme="slate"] {
            @extend .theme-dark;
            --color-bg-primary: #1e293b;
            --color-bg-panel: #0f172a;
            --color-text-primary: #f1f5f9;
            --color-text-muted: #94a3b8;
            --color-border: #334155;
            --color-button-bg: #334155;
            --color-button-hover: #475569;
            --color-selected-row: #38bdf8;
        }
        :root[data-ui-theme="abyss"] {
            @extend .theme-dark;
            --color-bg-primary: #0c0a09;
            --color-bg-panel: #000000;
            --color-text-primary: #fde68a;
            --color-text-muted: #a16207;
            --color-border: #292524;
            --color-button-bg: #292524;
            --color-button-hover: #44403c;
            --color-selected-row: #7c2d12;
        }
        :root[data-ui-theme="forest"] {
            @extend .theme-dark;
            --color-bg-primary: #13221b;
            --color-bg-panel: #0b120f;
            --color-text-primary: #d1fae5;
            --color-text-muted: #6ee7b7;
            --color-border: #065f46;
            --color-button-bg: #065f46;
            --color-button-hover: #047857;
            --color-selected-row: #34d399;
        }
        :root[data-ui-theme="crimson"] {
            @extend .theme-dark;
            --color-bg-primary: #2b0b0b;
            --color-bg-panel: #1b0707;
            --color-text-primary: #fee2e2;
            --color-text-muted: #fca5a5;
            --color-border: #991b1b;
            --color-button-bg: #991b1b;
            --color-button-hover: #b91c1c;
            --color-selected-row: #fbbf24;
        }
        :root[data-ui-theme="royal"] {
            @extend .theme-dark;
            --color-bg-primary: #1e1b4b;
            --color-bg-panel: #17143a;
            --color-text-primary: #e0e7ff;
            --color-text-muted: #a5b4fc;
            --color-border: #4338ca;
            --color-button-bg: #4338ca;
            --color-button-hover: #4f46e5;
            --color-selected-row: #f472b6;
        }
        :root[data-ui-theme="mocha"] {
            @extend .theme-dark;
            --color-bg-primary: #2d1b0f;
            --color-bg-panel: #1e120a;
            --color-text-primary: #fde4d5;
            --color-text-muted: #f9ab77;
            --color-border: #7c2d12;
            --color-button-bg: #7c2d12;
            --color-button-hover: #9a3412;
            --color-selected-row: #4ade80;
        }
        :root[data-ui-theme="rose-pine"] {
            @extend .theme-dark;
            --color-bg-primary: #191724;
            --color-bg-panel: #1f1d2e;
            --color-text-primary: #e0def4;
            --color-text-muted: #908caa;
            --color-border: #44415a;
            --color-button-bg: #26233a;
            --color-button-hover: #312f4c;
            --color-selected-row: #c4a7e7;
        }

        /* Table row hover and selection */
        .aircraft-row {
            cursor: pointer;
            transition: background-color 0.1s;
        }
        .aircraft-row:nth-child(odd):not(.selected-row) {
            background-color: var(--color-table-odd-row);
        }
        .aircraft-row:hover:not(.selected-row) {
            background-color: var(--color-button-hover);
        }
        .selected-row {
            background-color: var(--color-selected-row) !important;
        }

        /* Button styles */
        .btn {
            padding: 0.25rem 0.75rem;
            border-radius: 0.375rem;
            font-size: 0.875rem;
            background-color: var(--color-button-bg);
            transition: background-color 0.2s;
        }
        .btn:hover {
            background-color: var(--color-button-hover);
        }
    </style>
</head>
<body class="font-mono antialiased" style="background-color: var(--color-bg-primary); color: var(--color-text-primary);">
    <div class="h-full flex flex-col">
        <!-- Header -->
        <header class="flex-shrink-0 border-b px-2 py-1 flex items-center justify-between z-20" style="background-color: var(--color-bg-panel); border-color: var(--color-border);">
            <div class="flex items-baseline gap-3">
                <h1 class="text-lg font-bold">ADSB Scope</h1>
                <span id="version-display" class="text-xs rounded-md px-2 py-0.5 bg-opacity-60" style="background-color: var(--color-button-bg); color: var(--color-text-muted);"></span>
            </div>
            <div id="scope-status-bar" class="hidden md:flex justify-center items-center gap-x-4 text-xs" style="color: var(--color-text-muted);"></div>
            <div class="flex items-center gap-2">
                <button id="hide-ui-button" class="btn">Hide Panels</button>
                <div class="relative">
                    <button id="ui-theme-button" class="btn">UI Theme</button>
                    <div id="ui-theme-menu" class="absolute right-0 mt-2 w-48 border rounded-md shadow-lg hidden origin-top-right dropdown-menu overflow-y-auto max-h-60" style="background-color: var(--color-bg-panel); border-color: var(--color-border);"></div>
                </div>
                <div class="relative">
                    <button id="scope-theme-button" class="btn">Scope Theme</button>
                    <div id="scope-theme-menu" class="absolute right-0 mt-2 w-48 border rounded-md shadow-lg hidden origin-top-right dropdown-menu overflow-y-auto max-h-60" style="background-color: var(--color-bg-panel); border-color: var(--color-border);"></div>
                </div>
            </div>
        </header>

        <!-- Main content -->
        <main class="flex-grow flex overflow-hidden">
            <!-- Left panel -->
            <div id="left-panel" class="w-48 flex flex-col overflow-hidden border-r flex-shrink-0" style="background-color: var(--color-bg-panel); border-color: var(--color-border);">
                <h2 class="p-2 font-bold text-center border-b flex-shrink-0" style="border-color: var(--color-border);">Tracked Aircraft</h2>
                <div class="overflow-y-auto text-xs">
                    <table class="w-full">
                        <thead class="sticky top-0" style="background-color: var(--color-table-header);">
                            <tr>
                                <th class="table-cell text-left">Flight</th>
                                <th class="table-cell text-right">Alt (ft)</th>
                                <th class="table-cell text-right">Speed (kt)</th>
                                <th class="table-cell text-right">Dist (nm)</th>
                            </tr>
                        </thead>
                        <tbody id="aircraft-list-body"></tbody>
                    </table>
                </div>
            </div>
            
            <div id="left-resizer" class="resizer flex-shrink-0"><div class="resizer-indicator"></div></div>

            <!-- Canvas container -->
            <div class="flex-grow flex flex-col">
                <div id="canvas-container" class="flex-grow relative">
                    <canvas id="radarCanvas" class="absolute top-0 left-0 w-full h-full"></canvas>
                    <div id="aircraft-popup" class="absolute bg-black bg-opacity-70 text-white text-xs p-2 rounded-md hidden whitespace-pre-wrap"></div>
                    <div id="alert-container" class="absolute top-2 right-2 space-y-2"></div>
                </div>
            </div>
            
            <div id="right-resizer" class="resizer flex-shrink-0"><div class="resizer-indicator"></div></div>

            <!-- Right panel -->
            <div id="right-panel" class="w-48 flex flex-col overflow-hidden border-l flex-shrink-0" style="background-color: var(--color-bg-panel); border-color: var(--color-border);">
                <h2 class="p-2 font-bold text-center border-b flex-shrink-0" style="border-color: var(--color-border);">Metrics</h2>
                <div id="metrics-panel" class="p-2 space-y-2 text-xs overflow-y-auto"></div>
                <div class="flex-shrink-0 p-2 text-xs">
                    <hr class="mb-2" style="border-color: var(--color-border);">
                    <div class="font-bold text-center mb-2">Shortcuts</div>
                    <div id="shortcut-bar" class="grid grid-cols-2 gap-x-4 gap-y-1" style="color: var(--color-text-muted);"></div>
                </div>
            </div>
        </main>
    </div>
    
    <!-- Paused overlay -->
    <div id="pausedText" class="fixed inset-0 flex items-center justify-center z-50 hidden bg-black bg-opacity-50">
        <h1 class="text-4xl font-bold tracking-widest animate-pulse text-white">PAUSED</h1>
    </div>
    
    <!-- Help modal -->
    <div id="help-modal" class="fixed inset-0 flex items-center justify-center z-50 hidden bg-black bg-opacity-50">
        <div class="p-6 rounded-lg shadow-2xl w-full max-w-lg" style="background-color: var(--color-bg-panel);">
            <h2 class="text-2xl font-bold mb-4">Help & Shortcuts</h2>
            <p class="mb-4">Real-time ADSB aircraft tracking radar scope. Connect to tar1090 or similar data sources to visualize aircraft positions.</p>
            <div id="help-shortcut-list" class="grid grid-cols-2 gap-4 text-sm mb-4"></div>
            <button id="close-help-button" class="w-full py-2 bg-blue-500 text-white rounded-md hover:bg-blue-600">Close</button>
        </div>
    </div>

    <script>
    // Main application wrapped in IIFE for better encapsulation
    (function() {
        'use strict';
        
        // Configuration Constants
        const CONFIG = {
            VERSION: "0.2.0",
            TAR1090_URL: "data/aircraft.json",
            HOME_LAT: 00.00000,
            HOME_LON: -00.00000,
            SWEEP_DURATION_S: 7.2,
            FETCH_INTERVAL_MS: 2000,
            FETCH_TIMEOUT_MS: 4000,
            UI_UPDATE_INTERVAL_MS: 333,
            MAX_TRAIL_LENGTH: 10,
            AIRCRAFT_TIMEOUT_FACTOR: 1.5,
            EMERGENCY_SQUAWKS: ['7500', '7600', '7700'],
            ALERT_DURATION_MS: 6000,
            MIN_RANGE_NM: 5,
            MAX_RANGE_NM: 200,
            RANGE_STEP_NM: 5,
            DEFAULT_RANGE_NM: 50,
            CLICK_RADIUS_PX: 15,
            AIRCRAFT_SYMBOL_SIZE: 4,
            HEADING_LINE_LENGTH: 12,
            RESIZER_WIDTH: 5,
            CANVAS_PADDING: 30
        };

        // Theme definitions
        const UI_THEMES = [
            { name: "Default Dark", key: "default-dark", group: "Dark" },    
            { name: "Default Light", key: "default-light", group: "Light" },
            { name: "Stone", key: "stone", group: "Light" },
            { name: "Mint", key: "mint", group: "Light" },
            { name: "Sky", key: "sky", group: "Light" },
            { name: "Lavender", key: "lavender", group: "Light" },
            { name: "Paper", key: "paper", group: "Light" },
            { name: "Azure", key: "azure", group: "Light" },
            { name: "Slate", key: "slate", group: "Dark" },
            { name: "Abyss", key: "abyss", group: "Dark" },
            { name: "Forest", key: "forest", group: "Dark" },
            { name: "Crimson", key: "crimson", group: "Dark" },
            { name: "Royal", key: "royal", group: "Dark" },
            { name: "Mocha", key: "mocha", group: "Dark" },
            { name: "Rose Pine", key: "rose-pine", group: "Dark" }
        ];

        const SCOPE_THEMES = [
            "classic-green", "arctic-blue", "desert-amber", "night-vision", "stealth-gray",
            "crimson-alert", "cyberpunk", "solar-flare", "deep-ocean", "forest-camo",
            "volcanic-ash", "nebula-purple", "ghost-white", "golden-age", "retro-vga",
            "toxic-sludge", "strawberry-cream", "blueprint", "hacker-matrix", "autumn-leaves",
            "coral-reef", "lunar-rock", "sandstone", "royal-velvet", "mint-chocolate",
            "infrared-heat", "plasma-burn", "cold-steel", "digital-rain", "copper-rust",
            "aurora-borealis", "vintage-sepia", "acid-wash", "moonlit", "lava-flow",
            "emerald-city", "grape-soda", "starfield", "jungle", "biohazard",
            "daylight", "cad", "blueprint-light", "paper-map", "arctic-light",
            "sandstorm", "medical", "clean-room", "graph-paper", "hi-vis"
        ].map(key => ({ name: key.replace(/-/g, ' ').replace(/\b\w/g, c => c.toUpperCase()), key }));

        // Application State
        const state = {
            aircraftData: {},
            displayedAircraft: {},
            sessionStats: {
                uniqueAircraft: new Set(),
                maxConcurrent: 0,
                startTime: Date.now(),
                messagesReceived: 0
            },
            selectedHex: null,
            connectionStatus: "Connecting...",
            isPaused: false,
            sweepAngle: 0,
            prevSweepAngle: 0,
            maxRangeNm: CONFIG.DEFAULT_RANGE_NM,
            scopeThemeIndex: 0,
            uiTheme: 'default-dark',
            aircraftFilter: 'all', // 'all', 'military', 'civilian'
            activeAlerts: new Set(),
            lastUiUpdateTime: 0
        };

        // DOM Elements Cache
        const elements = {
            canvas: document.getElementById('radarCanvas'),
            canvasContainer: document.getElementById('canvas-container'),
            versionDisplay: document.getElementById('version-display'),
            aircraftListBody: document.getElementById('aircraft-list-body'),
            metricsPanel: document.getElementById('metrics-panel'),
            shortcutBar: document.getElementById('shortcut-bar'),
            scopeStatusBar: document.getElementById('scope-status-bar'),
            pausedText: document.getElementById('pausedText'),
            aircraftPopup: document.getElementById('aircraft-popup'),
            alertContainer: document.getElementById('alert-container'),
            uiThemeButton: document.getElementById('ui-theme-button'),
            uiThemeMenu: document.getElementById('ui-theme-menu'),
            scopeThemeButton: document.getElementById('scope-theme-button'),
            scopeThemeMenu: document.getElementById('scope-theme-menu'),
            hideUiButton: document.getElementById('hide-ui-button'),
            leftPanel: document.getElementById('left-panel'),
            rightPanel: document.getElementById('right-panel'),
            leftResizer: document.getElementById('left-resizer'),
            rightResizer: document.getElementById('right-resizer'),
            helpModal: document.getElementById('help-modal'),
            closeHelpButton: document.getElementById('close-help-button'),
            ctx: null // Will be initialized after canvas
        };
        elements.ctx = elements.canvas.getContext('2d');

        // Utility Functions
        const MathUtils = {
            toRad: (deg) => deg * Math.PI / 180,
            toDeg: (rad) => rad * 180 / Math.PI,
            
            haversineDistance(lat1, lon1, lat2, lon2) {
                const R = 3440.065; // Nautical miles
                const dLat = this.toRad(lat2 - lat1);
                const dLon = this.toRad(lon2 - lon1);
                const a = Math.sin(dLat / 2) ** 2 + 
                         Math.cos(this.toRad(lat1)) * Math.cos(this.toRad(lat2)) * 
                         Math.sin(dLon / 2) ** 2;
                return R * (2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a)));
            },
            
            bearing(lat1, lon1, lat2, lon2) {
                const lat1Rad = this.toRad(lat1);
                const lat2Rad = this.toRad(lat2);
                const dLon = this.toRad(lon2 - lon1);
                const y = Math.sin(dLon) * Math.cos(lat2Rad);
                const x = Math.cos(lat1Rad) * Math.sin(lat2Rad) - 
                         Math.sin(lat1Rad) * Math.cos(lat2Rad) * Math.cos(dLon);
                return (this.toDeg(Math.atan2(y, x)) + 360) % 360;
            },
            
            latLonToScreen(lat, lon, maxRange, centerX, centerY, radius) {
                const distNm = this.haversineDistance(CONFIG.HOME_LAT, CONFIG.HOME_LON, lat, lon);
                if (distNm > maxRange) return null;
                const brngDeg = this.bearing(CONFIG.HOME_LAT, CONFIG.HOME_LON, lat, lon);
                const screenAngleRad = this.toRad(brngDeg - 90);
                const distPx = (distNm / maxRange) * radius;
                return {
                    x: centerX + distPx * Math.cos(screenAngleRad),
                    y: centerY + distPx * Math.sin(screenAngleRad),
                    dist: distNm
                };
            }
        };

        // Theme Management
        const ThemeManager = {
            applyUiTheme() {
                document.documentElement.setAttribute('data-ui-theme', state.uiTheme);
            },
            
            getScopeThemeColor(colorName) {
                const themeKey = SCOPE_THEMES[state.scopeThemeIndex].key;
                const colorConfig = tailwind.config.theme.extend.colors[themeKey] || {};
                return colorConfig[colorName] || '#FF00FF';
            }
        };

        // Data Management
        const DataManager = {
            async fetchData() {
                try {
                    const controller = new AbortController();
                    const timeoutId = setTimeout(() => controller.abort(), CONFIG.FETCH_TIMEOUT_MS);
                    
                    const response = await fetch(CONFIG.TAR1090_URL, { 
                        signal: controller.signal,
                        cache: 'no-cache'
                    });
                    clearTimeout(timeoutId);

                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    
                    const data = await response.json();
                    this.processAircraftData(data);
                    state.connectionStatus = "OK";
                } catch (error) {
                    state.connectionStatus = error.name === 'AbortError' ? "Timeout" : "Error";
                    console.error('Fetch error:', error);
                }
            },
            
            processAircraftData(data) {
                const newData = {};
                const aircraft = data.aircraft || [];
                
                for (const ac of aircraft) {
                    if (!this.isValidAircraft(ac)) continue;
                    
                    const hex = ac.hex.trim().toUpperCase();
                    newData[hex] = ac;
                    state.sessionStats.uniqueAircraft.add(hex);
                    
                    if (CONFIG.EMERGENCY_SQUAWKS.includes(ac.squawk)) {
                        UIManager.createEmergencyAlert(ac);
                    }
                }
                
                state.aircraftData = newData;
                state.sessionStats.messagesReceived = data.messages || state.sessionStats.messagesReceived;
            },
            
            isValidAircraft(aircraft) {
                return aircraft && 
                       'lat' in aircraft && 
                       'lon' in aircraft && 
                       aircraft.hex && 
                       aircraft.hex.trim();
            },
            
            isMilitary(hex) {
                const icao = parseInt(hex, 16);
                return (icao >= 0xADF7C0 && icao <= 0xADFFFF) || 
                       (icao >= 0xAE0000 && icao <= 0xAE7FFF);
            }
        };

        // Rendering Engine
        const Renderer = {
            drawScope(cx, cy, radius) {
                const ctx = elements.ctx;
                
                // Background
                ctx.fillStyle = ThemeManager.getScopeThemeColor('background');
                ctx.fillRect(0, 0, elements.canvas.width, elements.canvas.height);
                
                // Grid
                ctx.strokeStyle = ThemeManager.getScopeThemeColor('grid');
                ctx.lineWidth = 1.2;
                
                // Range rings
                for (let i = 1; i <= 4; i++) {
                    ctx.beginPath();
                    ctx.arc(cx, cy, radius * (i / 4), 0, 2 * Math.PI);
                    ctx.stroke();
                }
                
                // Crosshairs
                ctx.beginPath();
                ctx.moveTo(cx - radius, cy);
                ctx.lineTo(cx + radius, cy);
                ctx.moveTo(cx, cy - radius);
                ctx.lineTo(cx, cy + radius);
                ctx.stroke();
                
                // Tick marks
                for (let i = 0; i < 360; i += 10) {
                    const angleRad = MathUtils.toRad(i);
                    const tickLength = (i % 90 === 0) ? 12 : ((i % 30 === 0) ? 8 : 4);
                    const endR = radius + tickLength;
                    ctx.beginPath();
                    ctx.moveTo(cx + radius * Math.cos(angleRad), cy + radius * Math.sin(angleRad));
                    ctx.lineTo(cx + endR * Math.cos(angleRad), cy + endR * Math.sin(angleRad));
                    ctx.stroke();
                }
                
                // Labels
                ctx.fillStyle = ThemeManager.getScopeThemeColor('text');
                ctx.font = `${Math.max(10, radius * 0.035)}px monospace`;
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                
                // Degree markers
                ctx.font = `${Math.max(5, radius * 0.015)}px monospace`;
                for (let i = 20; i < 360; i += 20) {
                    if (i % 90 === 0) continue;
                    const angleRad = MathUtils.toRad(i - 90);
                    const textX = cx + (radius + 18) * Math.cos(angleRad);
                    const textY = cy + (radius + 18) * Math.sin(angleRad);
                    ctx.fillText(i.toString(), textX, textY);
                }
                
                // Cardinal directions
                const textRadius = radius + 25;
                ctx.font = `${Math.max(10, radius * 0.035)}px monospace`;
                ctx.fillText("N", cx, cy - textRadius);
                ctx.fillText("E", cx + textRadius, cy);
                ctx.fillText("S", cx, cy + textRadius);
                ctx.fillText("W", cx - textRadius, cy);
            },
            
            drawSweep(cx, cy, radius) {
                const ctx = elements.ctx;
                const sweepColor = ThemeManager.getScopeThemeColor('sweep');
                
                for (let i = 0; i < 10; i++) {
                    const angleOffset = state.sweepAngle - i * 0.2;
                    const lineAngleRad = MathUtils.toRad(angleOffset);
                    ctx.beginPath();
                    ctx.moveTo(cx, cy);
                    ctx.lineTo(cx + radius * Math.cos(lineAngleRad), cy + radius * Math.sin(lineAngleRad));
                    ctx.strokeStyle = sweepColor;
                    ctx.globalAlpha = 0.4 - i * 0.04;
                    ctx.lineWidth = 3;
                    ctx.stroke();
                }
                ctx.globalAlpha = 1.0;
            },
            
            drawAircraft(canvasWidth) {
                const ctx = elements.ctx;
                const currentTime = Date.now() / 1000;
                
                Object.keys(state.displayedAircraft).forEach(hex => {
                    const ac = state.displayedAircraft[hex];
                    const timeSinceUpdate = currentTime - ac.lastUpdateTime;
                    
                    if (timeSinceUpdate > CONFIG.SWEEP_DURATION_S * CONFIG.AIRCRAFT_TIMEOUT_FACTOR) {
                        delete state.displayedAircraft[hex];
                        return;
                    }
                    
                    const alpha = 1.0 - Math.min(1.0, timeSinceUpdate / CONFIG.SWEEP_DURATION_S) * 0.5;
                    const isEmergency = CONFIG.EMERGENCY_SQUAWKS.includes(ac.data.squawk) && 
                                      (Math.floor(currentTime * 4) % 2);
                    
                    let colorKey = ac.data.gnd ? 'ground' : 'aircraft';
                    if (isEmergency) colorKey = 'emergency';
                    else if (hex === state.selectedHex) colorKey = 'selected';
                    
                    const color = ThemeManager.getScopeThemeColor(colorKey);
                    
                    // Draw trail
                    if (ac.trail.length > 1) {
                        ctx.lineWidth = 2;
                        for (let i = 0; i < ac.trail.length - 1; i++) {
                            const p1 = ac.trail[i];
                            const p2 = ac.trail[i + 1];
                            const ratio = i / (ac.trail.length - 1);
                            ctx.beginPath();
                            ctx.moveTo(p1.x, p1.y);
                            ctx.lineTo(p2.x, p2.y);
                            ctx.strokeStyle = color;
                            ctx.globalAlpha = alpha * (0.2 + 0.8 * ratio);
                            ctx.stroke();
                        }
                    }
                    
                    ctx.globalAlpha = alpha;
                    const { x, y } = ac.displayPos;
                    ctx.fillStyle = ctx.strokeStyle = color;
                    ctx.lineWidth = 2;
                    ctx.beginPath();
                    
                    // Draw symbol
                    if (ac.data.gnd) {
                        ctx.rect(x - CONFIG.AIRCRAFT_SYMBOL_SIZE, y - CONFIG.AIRCRAFT_SYMBOL_SIZE,
                                CONFIG.AIRCRAFT_SYMBOL_SIZE * 2, CONFIG.AIRCRAFT_SYMBOL_SIZE * 2);
                    } else {
                        ctx.arc(x, y, CONFIG.AIRCRAFT_SYMBOL_SIZE, 0, 2 * Math.PI);
                    }
                    ctx.fill();
                    
                    // Draw heading line
                    if (!ac.data.gnd && ac.displayHeading) {
                        const headingRad = MathUtils.toRad(ac.displayHeading - 90);
                        ctx.beginPath();
                        ctx.moveTo(x + 6 * Math.cos(headingRad), y + 6 * Math.sin(headingRad));
                        ctx.lineTo(x + CONFIG.HEADING_LINE_LENGTH * Math.cos(headingRad), 
                                  y + CONFIG.HEADING_LINE_LENGTH * Math.sin(headingRad));
                        ctx.stroke();
                    }
                    
                    // Draw labels
                    ctx.fillStyle = ThemeManager.getScopeThemeColor('text');
                    const onLeftHalf = x < canvasWidth / 2;
                    ctx.textAlign = onLeftHalf ? 'left' : 'right';
                    const xPos = onLeftHalf ? x + 15 : x - 15;
                    ctx.font = '12px monospace';
                    ctx.fillText((ac.data.flight || 'N/A').trim(), xPos, y + 5);
                    ctx.font = '10px monospace';
                    ctx.fillText(`${ac.data.alt_baro || '???'}ft | ${ac.data.gs || '???'}kt`, xPos, y + 18);
                });
                
                ctx.globalAlpha = 1.0;
                ctx.textAlign = 'center';
            }
        };

        // UI Manager
        const UIManager = {
            updateAircraftList() {
                const sortedAircraft = Object.values(state.displayedAircraft)
                    .sort((a, b) => (a.dist ?? Infinity) - (b.dist ?? Infinity));
                
                if (sortedAircraft.length === 0) {
                    elements.aircraftListBody.innerHTML = 
                        `<tr><td colspan="4" class="text-center p-4" style="color: var(--color-text-muted);">No aircraft in range</td></tr>`;
                    return;
                }
                
                elements.aircraftListBody.innerHTML = sortedAircraft.map(ac => {
                    const isSelected = ac.data.hex === state.selectedHex;
                    return `<tr class="aircraft-row ${isSelected ? 'selected-row' : ''}" data-hex="${ac.data.hex}">
                        <td class="table-cell font-bold">${ac.data.flight?.trim() || ac.data.hex.slice(0, 6)}</td>
                        <td class="table-cell text-right">${ac.data.alt_baro || 'N/A'}</td>
                        <td class="table-cell text-right">${ac.data.gs || 'N/A'}</td>
                        <td class="table-cell text-right">${ac.dist?.toFixed(1) || 'N/A'}</td>
                    </tr>`;
                }).join('');
            },
            
            updateMetricsPanel() {
                const stats = this.calculateMetrics();
                const metricItem = (label, value) => 
                    `<div class="flex justify-between"><span>${label}:</span> <span class="font-bold">${value}</span></div>`;
                
                elements.metricsPanel.innerHTML = `
                    ${metricItem('Uptime (min)', stats.uptime)}
                    ${metricItem('Max Tracked', state.sessionStats.maxConcurrent)}
                    ${metricItem('Unique Today', state.sessionStats.uniqueAircraft.size)}
                    ${metricItem('Messages', state.sessionStats.messagesReceived.toLocaleString())}
                    <hr class="my-1" style="border-color: var(--color-border);">
                    ${metricItem('On Ground', stats.groundCount)}
                    ${metricItem('Emergency', stats.emergencyCount)}
                    ${metricItem('Avg Altitude', stats.avgAltitude)}
                    <hr class="my-1" style="border-color: var(--color-border);">
                    <div class="text-center font-bold text-sm">Live Bests</div>
                    ${metricItem('Closest', stats.closest)}
                    ${metricItem('Fastest', stats.fastest)}
                    ${metricItem('Highest', stats.highest)}
                    ${metricItem('Lowest', stats.lowest)}
                `;
            },
            
            calculateMetrics() {
                const uptime = ((Date.now() - state.sessionStats.startTime) / 1000 / 60).toFixed(1);
                let fastest = { gs: 0 };
                let closest = { dist: Infinity };
                let highest = { alt_baro: -99999 };
                let lowest = { alt_baro: 99999 };
                let emergencyCount = 0;
                let groundCount = 0;
                let totalAltitude = 0;
                let airborneCount = 0;
                
                Object.values(state.displayedAircraft).forEach(ac => {
                    if (ac.data.gnd) {
                        groundCount++;
                    } else {
                        airborneCount++;
                        totalAltitude += ac.data.alt_baro || 0;
                        if ((ac.data.gs || 0) > fastest.gs) fastest = ac.data;
                        if ((ac.data.alt_baro || -99999) > highest.alt_baro) highest = ac.data;
                        if ((ac.data.alt_baro || 99999) < lowest.alt_baro) lowest = ac.data;
                    }
                    
                    if ((ac.dist || Infinity) < closest.dist) {
                        closest = { ...ac.data, dist: ac.dist };
                    }
                    
                    if (CONFIG.EMERGENCY_SQUAWKS.includes(ac.data.squawk)) {
                        emergencyCount++;
                    }
                });
                
                const avgAltitude = airborneCount > 0 ? (totalAltitude / airborneCount).toFixed(0) : 'N/A';
                
                return {
                    uptime,
                    groundCount,
                    emergencyCount,
                    avgAltitude,
                    closest: closest.dist !== Infinity ? 
                        `${closest.flight?.trim() || closest.hex} (${closest.dist.toFixed(1)} nm)` : 'N/A',
                    fastest: fastest.gs > 0 ? 
                        `${fastest.flight?.trim() || fastest.hex} (${fastest.gs} kt)` : 'N/A',
                    highest: highest.alt_baro > -99999 ? 
                        `${highest.flight?.trim() || highest.hex} (${highest.alt_baro} ft)` : 'N/A',
                    lowest: lowest.alt_baro < 99999 && airborneCount > 0 ? 
                        `${lowest.flight?.trim() || lowest.hex} (${lowest.alt_baro} ft)` : 'N/A'
                };
            },
            
            updateScopeStatus() {
                elements.scopeStatusBar.innerHTML = [
                    `RANGE: ${state.maxRangeNm} NM`,
                    `CONN: ${state.connectionStatus}`,
                    `TRACKED: ${Object.keys(state.displayedAircraft).length}`,
                    `FILTER: ${state.aircraftFilter.toUpperCase()}`
                ].map(item => `<span>${item}</span>`).join('<span class="mx-2">|</span>');
            },
            
            createShortcutBar() {
                const shortcuts = {
                    "H": "Help",
                    "Space": "Pause",
                    "+/-": "Range",
                    "M": "Mil/Civ/All",
                    "R": "Reset Setup",
                    "Click •": "Details"
                };
                
                const kbdStyle = "font-sans px-1.5 py-0.5 text-xs font-semibold rounded-md border";
                const kbdColors = `background-color: var(--color-kbd-bg); color: var(--color-kbd-text); border-color: var(--color-kbd-border);`;
                
                elements.shortcutBar.innerHTML = Object.entries(shortcuts)
                    .map(([key, desc]) => 
                        `<div class="flex items-center gap-1">
                            <kbd class="${kbdStyle}" style="${kbdColors}">${key}</kbd> ${desc}
                        </div>`)
                    .join('');
                
                document.getElementById('help-shortcut-list').innerHTML = Object.entries(shortcuts)
                    .map(([key, desc]) => 
                        `<div><kbd class="${kbdStyle}" style="${kbdColors}">${key}</kbd> - ${desc}</div>`)
                    .join('');
            },
            
            createEmergencyAlert(aircraft) {
                const hex = aircraft.hex;
                if (state.activeAlerts.has(hex)) return;
                
                state.activeAlerts.add(hex);
                const alertDiv = document.createElement('div');
                alertDiv.className = 'bg-red-500 text-white p-2 rounded-md shadow-lg text-sm alert-animate';
                alertDiv.innerHTML = `<b>EMERGENCY</b><br>${aircraft.flight?.trim() || hex}<br>Squawk: ${aircraft.squawk}`;
                elements.alertContainer.appendChild(alertDiv);
                
                setTimeout(() => {
                    alertDiv.remove();
                    state.activeAlerts.delete(hex);
                }, CONFIG.ALERT_DURATION_MS);
            }
        };

        // Aircraft State Manager
        const AircraftStateManager = {
            updateAircraftState(cx, cy, radius) {
                const currentTime = Date.now() / 1000;
                state.sessionStats.maxConcurrent = Math.max(
                    state.sessionStats.maxConcurrent,
                    Object.keys(state.displayedAircraft).length
                );
                
                Object.values(state.aircraftData).forEach(ac_latest => {
                    const hex = ac_latest.hex.trim().toUpperCase();
                    
                    if (!this.shouldDisplayAircraft(ac_latest, hex)) {
                        if (state.displayedAircraft[hex]) {
                            delete state.displayedAircraft[hex];
                        }
                        return;
                    }
                    
                    const currentBrng = MathUtils.bearing(
                        CONFIG.HOME_LAT, CONFIG.HOME_LON,
                        ac_latest.lat, ac_latest.lon
                    );
                    
                    const sweepBrng = ((state.displayedAircraft[hex]?.compassBearing ?? currentBrng) - 90 + 360) % 360;
                    const isSwept = this.isInSweepArea(sweepBrng);
                    
                    if (isSwept) {
                        this.updateAircraftDisplay(hex, ac_latest, currentTime, currentBrng, cx, cy, radius);
                    }
                });
            },
            
            shouldDisplayAircraft(aircraft, hex) {
                if (typeof aircraft.alt_baro !== 'number') return false;
                
                if (state.aircraftFilter === 'military' && !DataManager.isMilitary(hex)) return false;
                if (state.aircraftFilter === 'civilian' && DataManager.isMilitary(hex)) return false;
                
                return true;
            },
            
            isInSweepArea(sweepBrng) {
                if (state.sweepAngle > state.prevSweepAngle) {
                    return sweepBrng > state.prevSweepAngle && sweepBrng <= state.sweepAngle;
                } else if (state.sweepAngle < state.prevSweepAngle) {
                    return sweepBrng > state.prevSweepAngle || sweepBrng <= state.sweepAngle;
                }
                return false;
            },
            
            updateAircraftDisplay(hex, ac_latest, currentTime, currentBrng, cx, cy, radius) {
                const screenPos = MathUtils.latLonToScreen(
                    ac_latest.lat, ac_latest.lon,
                    state.maxRangeNm, cx, cy, radius
                );
                
                if (!screenPos) {
                    if (state.displayedAircraft[hex]) {
                        delete state.displayedAircraft[hex];
                    }
                    return;
                }
                
                if (!state.displayedAircraft[hex]) {
                    state.displayedAircraft[hex] = { trail: [] };
                }
                
                const entry = state.displayedAircraft[hex];
                entry.lastUpdateTime = currentTime;
                entry.displayPos = screenPos;
                entry.displayHeading = ac_latest.track;
                entry.compassBearing = currentBrng;
                entry.data = ac_latest;
                entry.dist = screenPos.dist;
                
                entry.trail.push({ x: screenPos.x, y: screenPos.y });
                if (entry.trail.length > CONFIG.MAX_TRAIL_LENGTH) {
                    entry.trail.shift();
                }
            }
        };

        // Event Handlers
        const EventHandlers = {
            initializeEventListeners() {
                // Theme dropdowns
                this.setupDropdowns();
                
                // Panel hiding
                elements.hideUiButton.addEventListener('click', this.togglePanels);
                
                // Resizers
                this.makeResizable(elements.leftPanel, elements.leftResizer);
                this.makeResizable(elements.rightPanel, elements.rightResizer);
                
                // Canvas interactions
                elements.canvas.addEventListener('click', this.handleCanvasClick);
                
                // Aircraft list selection
                elements.aircraftListBody.addEventListener('click', this.handleAircraftListClick);
                
                // Keyboard shortcuts
                window.addEventListener('keydown', this.handleKeydown);
                
                // Help modal
                elements.closeHelpButton.addEventListener('click', () => {
                    elements.helpModal.classList.add('hidden');
                });
            },
            
            setupDropdowns() {
                const toggleDropdown = (menu) => {
                    document.querySelectorAll('.dropdown-menu').forEach(m => {
                        if (m !== menu) m.classList.add('hidden');
                    });
                    menu.classList.toggle('hidden');
                };
                
                elements.uiThemeButton.addEventListener('click', (e) => {
                    e.stopPropagation();
                    toggleDropdown(elements.uiThemeMenu);
                });
                
                elements.scopeThemeButton.addEventListener('click', (e) => {
                    e.stopPropagation();
                    toggleDropdown(elements.scopeThemeMenu);
                });
                
                document.addEventListener('click', () => {
                    elements.uiThemeMenu.classList.add('hidden');
                    elements.scopeThemeMenu.classList.add('hidden');
                    elements.aircraftPopup.classList.add('hidden');
                });
                
                elements.uiThemeMenu.addEventListener('click', (e) => {
                    if (e.target.dataset.theme) {
                        state.uiTheme = e.target.dataset.theme;
                        ThemeManager.applyUiTheme();
                    }
                });
                
                elements.scopeThemeMenu.addEventListener('click', (e) => {
                    if (e.target.dataset.themeId) {
                        state.scopeThemeIndex = parseInt(e.target.dataset.themeId, 10);
                    }
                });
            },
            
            togglePanels() {
                const hiding = !elements.leftPanel.classList.contains('hidden');
                elements.leftPanel.classList.toggle('hidden', hiding);
                elements.rightPanel.classList.toggle('hidden', hiding);
                elements.leftResizer.classList.toggle('hidden', hiding);
                elements.rightResizer.classList.toggle('hidden', hiding);
                elements.hideUiButton.textContent = hiding ? 'Show Panels' : 'Hide Panels';
                state.displayedAircraft = {}; // Clear displayed aircraft on panel toggle
            },
            
            makeResizable(panel, resizer) {
                let startX, startWidth;
                
                const handleMouseMove = (e) => {
                    const newWidth = (resizer === elements.leftResizer) ?
                        e.clientX : document.body.clientWidth - e.clientX;
                    panel.style.width = `${Math.max(100, newWidth)}px`;
                };
                
                const handleMouseUp = () => {
                    document.body.style.cursor = 'default';
                    document.removeEventListener('mousemove', handleMouseMove);
                    document.removeEventListener('mouseup', handleMouseUp);
                };
                
                resizer.addEventListener('mousedown', (e) => {
                    startX = e.clientX;
                    startWidth = panel.offsetWidth;
                    document.body.style.cursor = 'col-resize';
                    document.addEventListener('mousemove', handleMouseMove);
                    document.addEventListener('mouseup', handleMouseUp);
                });
            },
            
            handleCanvasClick(e) {
                e.stopPropagation();
                let clickedHex = null;
                let closestDist = CONFIG.CLICK_RADIUS_PX;
                
                for (const hex in state.displayedAircraft) {
                    const ac = state.displayedAircraft[hex];
                    const dist = Math.hypot(e.offsetX - ac.displayPos.x, e.offsetY - ac.displayPos.y);
                    if (dist < closestDist) {
                        clickedHex = hex;
                        closestDist = dist;
                    }
                }
                
                if (clickedHex && state.displayedAircraft[clickedHex]) {
                    const acData = state.displayedAircraft[clickedHex].data;
                    const popupContent = Object.entries(acData)
                        .map(([key, value]) => `${key}: ${JSON.stringify(value)}`)
                        .join('\n');
                    
                    elements.aircraftPopup.textContent = popupContent;
                    elements.aircraftPopup.style.left = `${e.offsetX + 15}px`;
                    elements.aircraftPopup.style.top = `${e.offsetY + 15}px`;
                    elements.aircraftPopup.classList.remove('hidden');
                } else {
                    elements.aircraftPopup.classList.add('hidden');
                }
            },
            
            handleAircraftListClick(e) {
                const row = e.target.closest('.aircraft-row');
                if (row) {
                    const hex = row.dataset.hex;
                    state.selectedHex = state.selectedHex === hex ? null : hex;
                    UIManager.updateAircraftList();
                }
            },
            
            handleKeydown(e) {
                switch(e.key.toLowerCase()) {
                    case ' ':
                        e.preventDefault();
                        state.isPaused = !state.isPaused;
                        break;
                    case 'h':
                        elements.helpModal.classList.remove('hidden');
                        break;
                    case '+':
                    case '=':
                        state.maxRangeNm = Math.min(CONFIG.MAX_RANGE_NM, state.maxRangeNm + CONFIG.RANGE_STEP_NM);
                        break;
                    case '-':
                    case '_':
                        state.maxRangeNm = Math.max(CONFIG.MIN_RANGE_NM, state.maxRangeNm - CONFIG.RANGE_STEP_NM);
                        break;
                    case 'm':
                        const filters = ['all', 'military', 'civilian'];
                        state.aircraftFilter = filters[(filters.indexOf(state.aircraftFilter) + 1) % filters.length];
                        break;
                }
            }
        };

        // Main Loop 
        const ScopeLoop = {
            animationId: null,
            
            start() {
                this.animationId = requestAnimationFrame((time) => this.update(time));
            },
            
            stop() {
                if (this.animationId) {
                    cancelAnimationFrame(this.animationId);
                    this.animationId = null;
                }
            },
            
            update(time) {
                const w = elements.canvasContainer.clientWidth;
                const h = elements.canvasContainer.clientHeight;
                
                if (w <= 0 || h <= 0) {
                    this.animationId = requestAnimationFrame((time) => this.update(time));
                    return;
                }
                
                // Resize canvas if needed
                if (elements.canvas.width !== w || elements.canvas.height !== h) {
                    elements.canvas.width = w;
                    elements.canvas.height = h;
                }
                
                const cx = w / 2;
                const cy = h / 2;
                const radius = Math.min(cx, cy) - CONFIG.CANVAS_PADDING;
                
                // Update sweep angle
                state.prevSweepAngle = state.sweepAngle;
                if (!state.isPaused) {
                    state.sweepAngle = (time / 1000 * (360 / CONFIG.SWEEP_DURATION_S)) % 360;
                    AircraftStateManager.updateAircraftState(cx, cy, radius);
                }
                
                // Render
                Renderer.drawScope(cx, cy, radius);
                Renderer.drawAircraft(w);
                Renderer.drawSweep(cx, cy, radius);
                
                // Update UI at interval
                if (time - state.lastUiUpdateTime > CONFIG.UI_UPDATE_INTERVAL_MS) {
                    UIManager.updateAircraftList();
                    UIManager.updateMetricsPanel();
                    UIManager.updateScopeStatus();
                    state.lastUiUpdateTime = time;
                }
                
                // Update paused overlay
                elements.pausedText.classList.toggle('hidden', !state.isPaused);
                
                // Continue loop
                this.animationId = requestAnimationFrame((time) => this.update(time));
            }
        };

        // Initialization
        const App = {
            init() {
                // Set up page title and version
                document.title = `ADSB Radarscope | v${CONFIG.VERSION} | by dustsignal`;
                elements.versionDisplay.innerHTML = 
                    `<a href="https://github.com/dustsignal/adsb-scope" target="_blank" rel="noopener noreferrer" class="hover:underline">v${CONFIG.VERSION}</a>`;
                
                // Initialize theme menus
                this.initializeThemeMenus();
                
                // Set up UI components
                UIManager.createShortcutBar();
                ThemeManager.applyUiTheme();
                
                // Initialize event handlers
                EventHandlers.initializeEventListeners();
                
                // Start data fetching
                DataManager.fetchData();
                setInterval(() => DataManager.fetchData(), CONFIG.FETCH_INTERVAL_MS);
                
                // Start render loop
                ScopeLoop.start();
            },
            
            initializeThemeMenus() {
                // UI Theme Menu
                const groupedThemes = UI_THEMES.reduce((acc, theme) => {
                    (acc[theme.group] = acc[theme.group] || []).push(theme);
                    return acc;
                }, {});
                
                elements.uiThemeMenu.innerHTML = Object.entries(groupedThemes)
                    .map(([group, themes]) => `
                        <div class="px-4 py-1 text-xs font-bold" style="color: var(--color-text-muted);">${group}</div>
                        ${themes.map(t => 
                            `<a href="#" class="block px-4 py-2 text-sm hover:bg-opacity-10 hover:bg-white" data-theme="${t.key}">${t.name}</a>`
                        ).join('')}
                    `).join('');
                
                // Scope Theme Menu
                elements.scopeThemeMenu.innerHTML = SCOPE_THEMES
                    .map((t, i) => 
                        `<a href="#" class="block px-4 py-2 text-sm hover:bg-opacity-10 hover:bg-white" data-theme-id="${i}">${t.name}</a>`
                    ).join('');
            }
        };

        // Start application when DOM is ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', () => App.init());
        } else {
            App.init();
        }
    })();
    </script>
</body>
</html>
